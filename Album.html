<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= folderName ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <?!= include('CSS'); ?>
    <style>
      .image-thumbnail {
        width: 100%;
        height: 200px;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .image-thumbnail:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
      <header class="navbar navbar-light bg-light fixed-top shadow-sm">
        <div class="container-fluid">
          <a class="navbar-brand d-flex align-items-center" href="<?= ScriptApp.getService().getUrl() ?>">
            <img src="https://img2.pic.in.th/pic/60bc7192ac918d169457719850927ef6.png" alt="Logo" class="navbar-logo me-2">
            <span class="navbar-title d-none d-sm-block">อัลบั้มภาพ</span>
          </a>
          
          <span class="navbar-title mx-auto text-truncate px-2" title="<?= folderName ?>"><?= folderName ?></span>

          <div class="d-flex align-items-center" style="min-width: 130px; justify-content: flex-end;">
            <button class="btn btn-outline-primary btn-sm me-2" onclick="copyAlbumLink(this)" title="แชร์อัลบั้ม">
              <i class="fas fa-share-alt"></i>
              <span class="d-none d-md-inline ms-1">แชร์</span>
            </button>
            <a href="<?= ScriptApp.getService().getUrl(); ?>" class="btn btn-outline-secondary btn-sm" title="กลับหน้าหลัก">
              <i class="fas fa-arrow-left"></i>
              <span class="d-none d-md-inline ms-1">กลับ</span>
            </a>
          </div>
        </div>
      </header>    

    <div class="container my-4">

      <div id="image-grid" class="row row-cols-2 row-cols-md-4 g-4">
        </div>      
      
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4" id="pagination">
          </ul>
      </nav>

      <div id="loader" class="d-flex flex-column justify-content-center align-items-center" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.95); z-index: 9999;">
          <h4 class="mb-3 text-primary"><i class="fas fa-images"></i> กำลังโหลดรูปภาพ...</h4>
          <div class="progress w-50 shadow-sm" style="height: 20px;">
              <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <p id="progress-text" class="mt-2 fw-bold">0%</p>
      </div>
    </div>

  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
          <div class="modal-body text-center p-0 position-relative">
            <button type="button" class="btn-close btn-close-white" style="position:absolute; top:1rem; right:1rem; z-index:20;" data-bs-dismiss="modal" aria-label="Close"></button>
            
            <img src="" id="modalImage" class="img-fluid" alt="Enlarged image">
            
            <a id="downloadButton" href="#" download class="btn btn-primary btn-sm" style="position:absolute; bottom:1rem; left:1rem; z-index:20;"><i class="fas fa-download"></i> ดาวน์โหลด</a>

            <button class="carousel-control-prev" type="button" onclick="showPreviousImage()">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-arrow-left-square-fill" viewBox="0 0 16 16">
                <path d="M16 14a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2zm-4.5-6.5H5.707l2.147-2.146a.5.5 0 1 0-.708-.708l-3 3a.5.5 0 0 0 0 .708l3 3a.5.5 0 0 0 .708-.708L5.707 8.5H11.5a.5.5 0 0 0 0-1"/>
              </svg>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" onclick="showNextImage()">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-arrow-right-square-fill" viewBox="0 0 16 16">
                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm4.5 5.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z"/>
              </svg>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer mt-auto py-3 bg-light text-center">
      <div class="container">
        <span class="text-muted"><?= pageSubtitle ?> - พัฒนาโดย <a href="https://line.me/R/ti/p/@844qurpo" target="_blank" rel="noopener">IT-Com7</a></span>
      </div>
    </footer>    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
      const folderId = '<?= folderId ?>';
      let allImages = [];
      const imagesPerPage = 20;
      let currentPage = 1;
      let progressInterval = null;
      let currentImageIndex = 0;

      // --- ส่วนเริ่มต้นการทำงาน ---
      document.addEventListener('DOMContentLoaded', function() {
        showLoader();
        google.script.run.withSuccessHandler(displayImages).withFailureHandler(showError).getImagesInAlbum(folderId);
      });

      // --- ส่วนควบคุม Loader และการแสดงผลเริ่มต้น ---
      function showLoader() {
        const loader = document.getElementById('loader');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        loader.style.display = 'flex';
        document.getElementById('image-grid').style.display = 'none';
        let width = 0;
        progressInterval = setInterval(() => {
          if (width < 95) {
            width++;
            progressBar.style.width = width + '%';
            progressText.textContent = width + '%';
          } else {
            clearInterval(progressInterval);
          }
        }, 50);
      }

      function displayImages(images) {
        if (images.error) {
          showError(images.error);
          return;
        }
        clearInterval(progressInterval);
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        setTimeout(() => {
          const loader = document.getElementById('loader');
          if(loader) loader.remove();
          document.getElementById('image-grid').style.display = 'flex';
          allImages = images;
          if(allImages.length === 0){
             document.getElementById('image-grid').innerHTML = '<p class="text-center w-100">ไม่พบรูปภาพในอัลบั้มนี้</p>';
          } else {
            renderPage(currentPage);
          }
        }, 500);
      }

      // --- ส่วนแสดงผลรูปภาพและ Pagination ---
      function renderPage(page) {
        currentPage = page;
        const grid = document.getElementById('image-grid');
        grid.innerHTML = '';
        const start = (page - 1) * imagesPerPage;
        const paginatedImages = allImages.slice(start, start + imagesPerPage);
        paginatedImages.forEach((image, index) => {
          const absoluteIndex = start + index;
          const imgElement = `
            <div class="col">
              <div class="card shadow-sm">
                <img src="${image.url}" class="card-img-top image-thumbnail" alt="${image.name}" 
                     onclick="showImageModal(${absoluteIndex})">
              </div>
            </div>`;
          grid.innerHTML += imgElement;
        });
        setupPagination();
      }

       function setupPagination() {
        const totalItems = allImages.length;
        const pageCount = Math.ceil(totalItems / imagesPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if (pageCount <= 1) return;
        const maxVisiblePages = 5;
        let firstPageClass = currentPage === 1 ? 'page-item disabled' : 'page-item';
        pagination.innerHTML += `<li class="${firstPageClass}"><a class="page-link" href="#" onclick="renderPage(1); return false;">หน้าแรก</a></li>`;
        let prevPageNum = currentPage > 1 ? currentPage - 1 : 1;
        let prevPageClass = currentPage === 1 ? 'page-item disabled' : 'page-item';
        pagination.innerHTML += `<li class="${prevPageClass}"><a class="page-link" href="#" onclick="renderPage(${prevPageNum}); return false;">&laquo;</a></li>`;
        let startPage, endPage;
        if (pageCount <= maxVisiblePages) {
          startPage = 1;
          endPage = pageCount;
        } else {
          const maxPagesBeforeCurrent = Math.floor(maxVisiblePages / 2);
          const maxPagesAfterCurrent = Math.ceil(maxVisiblePages / 2) - 1;
          if (currentPage <= maxPagesBeforeCurrent) {
            startPage = 1;
            endPage = maxVisiblePages;
          } else if (currentPage + maxPagesAfterCurrent >= pageCount) {
            startPage = pageCount - maxVisiblePages + 1;
            endPage = pageCount;
          } else {
            startPage = currentPage - maxPagesBeforeCurrent;
            endPage = currentPage + maxPagesAfterCurrent;
          }
        }
        for (let i = startPage; i <= endPage; i++) {
          const liClass = (i === currentPage) ? 'page-item active' : 'page-item';
          pagination.innerHTML += `<li class="${liClass}"><a class="page-link" href="#" onclick="renderPage(${i}); return false;">${i}</a></li>`;
        }
        let nextPageNum = currentPage < pageCount ? currentPage + 1 : pageCount;
        let nextPageClass = currentPage === pageCount ? 'page-item disabled' : 'page-item';
        pagination.innerHTML += `<li class="${nextPageClass}"><a class="page-link" href="#" onclick="renderPage(${nextPageNum}); return false;">&raquo;</a></li>`;
        let lastPageClass = currentPage === pageCount ? 'page-item disabled' : 'page-item';
        pagination.innerHTML += `<li class="${lastPageClass}"><a class="page-link" href="#" onclick="renderPage(${pageCount}); return false;">หน้าสุดท้าย</a></li>`;
      }

      // --- ส่วนควบคุม Modal และ Carousel ---
      const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));

      function showImageModal(index) {
        currentImageIndex = index;
        updateModalContent();
        imageModal.show();
      }

      function updateModalContent() {
        if (allImages.length === 0) return;
        
        // อัปเดตข้อมูลรูปภาพและปุ่มดาวน์โหลด (เหมือนเดิม)
        const image = allImages[currentImageIndex];
        document.getElementById('modalImage').src = image.url;
        document.getElementById('modalImage').alt = image.name;
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.href = image.downloadUrl;
        downloadButton.setAttribute('download', image.name);

        // -- เพิ่ม: ส่วนควบคุมการแสดงผลของปุ่มควบคุม Carousel --
        const prevButton = document.querySelector('.carousel-control-prev');
        const nextButton = document.querySelector('.carousel-control-next');

        // คำนวณลำดับแรกและสุดท้ายของรูปภาพในหน้าปัจจุบัน
        const startIndex = (currentPage - 1) * imagesPerPage;
        const endIndex = Math.min(startIndex + imagesPerPage - 1, allImages.length - 1);

        // ตรวจสอบเพื่อซ่อนหรือแสดงปุ่ม "ก่อนหน้า"
        if (currentImageIndex <= startIndex) {
          prevButton.style.display = 'none';
        } else {
          prevButton.style.display = 'block';
        }

        // ตรวจสอบเพื่อซ่อนหรือแสดงปุ่ม "ถัดไป"
        if (currentImageIndex >= endIndex) {
          nextButton.style.display = 'none';
        } else {
          nextButton.style.display = 'block';
        }
      }

      function showNextImage() {
        const endIndex = Math.min(((currentPage - 1) * imagesPerPage) + imagesPerPage - 1, allImages.length - 1);
        if (currentImageIndex < endIndex) {
          currentImageIndex++;
          updateModalContent();
        }
      }

      function showPreviousImage() {
        const startIndex = (currentPage - 1) * imagesPerPage;
        if (currentImageIndex > startIndex) {
          currentImageIndex--;
          updateModalContent();
        }
      }

      document.addEventListener('keydown', function(event) {
          if (document.getElementById('imageModal').classList.contains('show')) {
              if (event.key === 'ArrowRight') {
                  showNextImage();
              } else if (event.key === 'ArrowLeft') {
                  showPreviousImage();
              } else if (event.key === 'Escape') {
                  imageModal.hide();
              }
          }
      });

      // --- ส่วนจัดการข้อผิดพลาดและฟังก์ชันเสริม ---
      function copyAlbumLink(element) {
        const baseUrl = '<?= ScriptApp.getService().getUrl(); ?>';
        //const shareUrl = `${baseUrl}?page=album&folderId=${folderId}`;
        const shareUrl = `${baseUrl}?page=album&folderId=${folderId}&openExternalBrowser=1`;
        navigator.clipboard.writeText(shareUrl).then(() => {
          const originalText = element.innerHTML;
          element.innerHTML = '<i class="fas fa-check"></i> คัดลอกแล้ว';
          element.disabled = true;
          setTimeout(() => {
              element.innerHTML = originalText;
              element.disabled = false;
          }, 2000);
          Swal.fire({
              icon: 'success',
              title: 'คัดลอกลิงก์อัลบั้มแล้ว!',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true
          });
        }).catch(err => {
            showError('ไม่สามารถคัดลอกลิงก์ได้: ' + err);
        });
      }

      function showError(error) {
        if(progressInterval) clearInterval(progressInterval);
        const loader = document.getElementById('loader');
        if(loader) loader.remove();
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: error.toString()
        });
        console.error(error);
      }
    </script>
  </body>
</html>
